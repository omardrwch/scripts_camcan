"""
This scripts reads the results in data_mf_out/camcan and organize them
for further analysis.

IMPORTANT:
 The following parameters must be set:
    - conditions (default = ['rest', 'task'])
    - params_index (0, 1, 2 or 3)
    - sensor_type ('mag', 'grad' or 'EOG')


Available data:
    - unexisting_files (list): files that were not generated by the code that performs
                               MF analysis, due to some exception (I noticed exceptions
                               happen during ICA sometimes)
    - subjects_incomplete (list): subjects for which at least one file is missing

    - n_channels_list (list): number of channels available for each subject

    - mf_subjects (list): all subjects that are not in subjects_incomplete, that is
                          the ones who have all MF files available

    - n_subjects  = len(mf_subjects)

    - n_channels  = n_channels_list[0] # assuming all channels are present in all subjects

    - channels_picks (list): contains channels' numbers (as in raw fif files)

    - channels_names (list): contains channels' names (as in raw fif files)


    - all_cumulants_rest     (array): shape (n_subjects, n_channels, 3, 15))
    - all_log_cumulants_rest (array): shape (n_subjects, n_channels, 3)
    - all_hmin_rest          (array): shape (n_subjects, n_channels)

    - all_cumulants_task     (array): shape (n_subjects, n_channels, 3, 15)
    - all_log_cumulants_task (array): shape (n_subjects, n_channels, 3)
    - all_hmin_rest_task     (array): shape (n_subjects, n_channels)

    - ch_name2number (dict): maps channel name to channel number

    - ch_name2index (dict): maps channel name to channel index, the index is useful
                            to access the arrays above, e.g. all_cumulants_rest

"""

import mf_config
import camcan_utils
import h5py
import numpy as np
import os.path as op

class MF_Results():
    """
    Stores data described above
    """
    def __init__(self):
        self.params = None
        self.sensor_type = None
        self.unexisting_files = None
        self.subjects_incomplete = None
        self.n_channels_list = None
        self.mf_subjects = None
        self.n_subjects = None
        self.n_channels = None
        self.channels_picks = None
        self.channels_names = None
        self.all_cumulants_rest = None
        self.all_log_cumulants_rest = None
        self.all_hmin_rest = None
        self.all_cumulants_task = None
        self.all_log_cumulants_task = None
        self.all_hmin_rest_task = None
        self.ch_name2number = None
        self.ch_name2index  = None

def get_results(params_index = 0, sensor_type = 'mag', conditions = ['rest', 'task']):

    #-------------------------------------------------------------------------------
    # Parameters
    #-------------------------------------------------------------------------------
    # Subjects and conditions
    subjects = camcan_utils.subjects
    # conditions = ['rest', 'task'] #camcan_utils.kinds

    # MF parameters
    mf_params = mf_config.get_mf_params()
    # params_index = 0

    # Choose sensor type
    # sensor_type = 'mag'

    # Output folder
    mf_io_info = mf_config.get_io_info()
    camcan_output_dir = mf_io_info['camcan_output_dir']

    #-------------------------------------------------------------------------------
    # Read files
    #-------------------------------------------------------------------------------

    # debug
    unexisting_files = []
    subjects_incomplete = [] # subjects with incomplete mf analysis
    n_channels_list = []
    #

    # dictionary to store results
    mf_results = {}

    for subject in subjects:
        mf_results[subject] = {}
        for condition in conditions:
            if sensor_type == 'mag':
                filename = op.join(camcan_output_dir,
                                   subject,
                                   condition + "_channel_mag_params_%d"%params_index +'.h5')
            elif sensor_type == 'grad':
                filename = op.join(camcan_output_dir,
                                   subject,
                                   condition + "_channel_grad_params_%d"%params_index +'.h5')

            elif sensor_type == 'EOG':
                filename = op.join(camcan_output_dir,
                                   'EOG',
                                   subject,
                                   condition + "_channel_EOG_params_%d"%params_index +'.h5')


            if op.isfile(filename):
                mf_results[subject][condition] = {}
                with h5py.File(filename, "r") as f:
                    log_cumulants = f['log_cumulants'][:]
                    cumulants = f['cumulants'][:]
                    hmin = f['hmin'][:]
                    params = f['params'].value
                    picks_ch_names = [name.decode('ascii') for name in f['picks_ch_names'][:].squeeze()]
                    channels_picks = f['channels_picks'][:]
                    n_channels_list.append(len(picks_ch_names))

                    # store results in dictionary
                    mf_results[subject][condition]['log_cumulants'] = log_cumulants
                    mf_results[subject][condition]['cumulants']     = cumulants
                    mf_results[subject][condition]['hmin']          = hmin
                    mf_results[subject][condition]['channels_picks']= channels_picks
                    mf_results[subject][condition]['picks_ch_names']= picks_ch_names
            else:
                unexisting_files.append(filename)
                subjects_incomplete.append(subject)

    subjects_incomplete = list(set(subjects_incomplete))


    #-------------------------------------------------------------------------------
    # Organize data in arrays (easier to do averages etc)
    #-------------------------------------------------------------------------------

    # Subjects with all mf analysis computed
    mf_subjects = [s for s in subjects if s not in subjects_incomplete]
    n_subjects  = len(mf_subjects)
    n_channels  = n_channels_list[0] # assuming all channels are present in all subjects

    # Channels picks and names (assuming all subjects have the same set of channels)
    channels_picks = mf_results[mf_subjects[0]]['rest']['channels_picks']
    channels_names = mf_results[mf_subjects[0]]['rest']['picks_ch_names']

    # Cumulants, log-cumulants and hmin for rest/task
    all_cumulants_rest     = np.zeros((n_subjects, n_channels, 3, 15))
    all_log_cumulants_rest = np.zeros((n_subjects, n_channels, 3))
    all_hmin_rest          = np.zeros((n_subjects, n_channels))

    all_cumulants_task     = np.zeros((n_subjects, n_channels, 3, 15))
    all_log_cumulants_task = np.zeros((n_subjects, n_channels, 3))
    all_hmin_rest_task     = np.zeros((n_subjects, n_channels))


    for subject_idx, subject in enumerate(mf_subjects):
        for condition in conditions:
            cumulants     = mf_results[subject][condition]['cumulants']
            log_cumulants = mf_results[subject][condition]['log_cumulants']
            hmin          = mf_results[subject][condition]['hmin']

            if condition == 'rest':
                all_cumulants_rest[subject_idx, :, :, :]   = cumulants
                all_log_cumulants_rest[subject_idx, :, :]  = log_cumulants
                all_hmin_rest[subject_idx, :]              = hmin
            if condition == 'task':
                all_cumulants_task[subject_idx, :, :, :]   = cumulants
                all_log_cumulants_task[subject_idx, :, :]  = log_cumulants
                all_hmin_rest_task[subject_idx, :]         = hmin

    #-------------------------------------------------------------------------------
    # Some other useful data
    #-------------------------------------------------------------------------------
    ch_name2number = dict(zip(channels_names, channels_picks))
    ch_name2index  = dict( zip( channels_names, list(range(len(channels_picks))) ) )

    #-------------------------------------------------------------------------------
    # Store and return
    #-------------------------------------------------------------------------------
    results = MF_Results()
    results.params      = mf_params[params_index]
    results.sensor_type = sensor_type
    results.unexisting_files = unexisting_files
    results.subjects_incomplete = subjects_incomplete
    results.n_channels_list = n_channels_list
    results.mf_subjects = mf_subjects
    results.n_subjects = n_subjects
    results.n_channels = n_channels
    results.channels_picks = channels_picks
    results.channels_names = channels_names
    results.all_cumulants_rest = all_cumulants_rest
    results.all_log_cumulants_rest = all_log_cumulants_rest
    results.all_hmin_rest = all_hmin_rest
    results.all_cumulants_task = all_cumulants_task
    results.all_log_cumulants_task = all_log_cumulants_task
    results.all_hmin_rest_task = all_hmin_rest_task
    results.ch_name2number = ch_name2number
    results.ch_name2index  = ch_name2index

    return results
